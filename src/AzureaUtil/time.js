var timeout_list = {},// {id: [time, fun]}
    interval_list = {};// {id: [time, fun, interval]}
    timeevent_list = (function() { // {id: [time, fun, i]}
    var timeevent_list = {},
        timeevent, i = -1;
    
    while (timeevent = getDbKey('TimeEvent' + (++i))) {
        timeevent_list[timeevent.substring(0, timeevent.indexOf(':'))] = [
            timeevent.substring(timeevent.indexOf(':') + 1, timeevent.indexOf('|')) - 0,
            eval('(function(){return ' + timeevent.substring(timeevent.indexOf('|') + 1) + '})()'),
            i
        ];
    }
    return timeevent_list;
})();


function attainSchedule() {
    var now = new Date().getTime(),
        id;
    
    for (id in timeout_list) {
        if (timeout_list[id][0] <= now) {
            timeout_list[id][1]();
            delete timeout_list[id];
        }
    }
    for (id in interval_list) {
        if (interval_list[id][0] <= now) {
            interval_list[id][0] = now + interval_list[id][2];
            interval_list[id][1]();
        }
    }
    for (id in timeevent_list) {
        if (timeevent_list[id][0] <= now) {
            timeevent_list[id][1]();
            deleteDbKey('TimeEvent' + timeevent_list[id][2]);
            delete timeevent_list[id];
        }
    }
}


addEventListener('PreProcessTimelineStatus', attainSchedule);
addEventListener('PostSendUpdateStatus', attainSchedule);
addEventListener('ReceiveFavorite', attainSchedule);
//attainSchedule();


function setTimeout(fun,  // @param Function:
                    ms) { // @param Number:
                          // @return Strings:
    var id = Math.floor(Math.random() * new Date().getTime()).toString(36);
    
    timeout_list[id] = [new Date().getTime() + ms, fun];
    return id;
}


function clearTimeout(id) { // @param Strings:
    delete timeout_list[id];
}


function setInterval(fun,  // @param Function:
                     ms) { // @param Number:
                           // @return Strings:
    var id = Math.floor(Math.random() * new Date().getTime()).toString(36);
    
    timeinterval_list[id] = [new Date().getTime() + ms, fun, ms];
    return id;
}


function clearInterval(id) { // @param Strings:
    delete timeinterval_list[id];
}


function setTimeevent(fun,  // @param String: Function = eval(String)
                      ms) { // @param Number: Date().getTime()
                            // @return Strings:
    var id = Math.floor(Math.random() * new Date().getTime()).toString(36),
        i = -1;
    
    while (getDbKey('TimeEvent' + (++i))) {
    }
    setDbKey('TimeEvent' + i, id + ':' + ms + '|' + fun);
    timeevent_list[id] = [ms, eval('(function(){return ' + fun + '})()'), i];
    return id;
}


function clearTimeevent(id) { // @param Strings:
    deleteDbKey('TimeEvent' + timeevent_list[id][2]);
    delete timeevent_list[id];
}


mixin(AzureaUtil.time, {
    'setTimeout': setTimeout,
    'clearTimeout': clearTimeout,
    'setInterval': setInterval,
    'clearInterval': clearInterval,
    'setTimeevent': setTimeevent,
    'clearTimeevent': clearTimeevent
});