// ==AzureaScript==
// @name AzureaVim
// @author http://c4se.sakura.ne.jp/profile.html
// @scriptUrl https://github.com/ne-sachirou/AzureaVim/raw/master/js/
// @date 2011-03-25
// @license MIT License
// ==/AzureaScript==
AzureaUtil={mixin:{},ApiProxy:{},db:{},event:{},time:{},template:{},yank:{},notify:{}};
(function(){function a(b,d,h){var j;if(h==null)h=true;for(j in d)if(h||typeof b[j]==="undefined")b[j]=d[j]}function e(b){if(!(this instanceof e))return new e(b);b=b||"";this.uri=r+b;return this}function c(b,d){System.settings.setValue("user.AzureaVim",b,encodeURIComponent(d));u[b]=d}function g(b){u[b]||(u[b]=decodeURIComponent(System.settings.getValue("user.AzureaVim",b)));return u[b]}function f(b){System.settings.setValue("user.AzureaVim",b,"");delete u[b]}function k(b,d){for(var h=p[b],j=-1;h[++j];)h[j]===
d&&h.splice(j,1);h.push(d)}function n(){var b=(new Date).getTime(),d;for(d in q)if(q[d][0]<=b){q[d][1]();delete q[d]}for(d in v)if(v[d][0]<=b){v[d][0]=b+v[d][2];v[d][1]()}for(d in timeevent_list)if(timeevent_list[d][0]<=b){timeevent_list[d][1]();f("TimeEvent"+timeevent_list[d][2]);delete timeevent_list[d]}}function o(b){System.isActive?System.showNotice(b):System.showMessage(b,b,1048576)}AzureaUtil.mixin=a;var r="http://localhost:10080/";e.prototype={submit:function(b,d,h){var j,s=this.uri,m=[],i;
for(i in d)d[i]&&m.push(i+"="+d[i]);m=encodeURI(m.join("&"));b=(b=b||"")?/\/$/.test(s)&&b.charAt(0)==="/"?s.substring(1)+b:!/\/$/.test(s)&&b.charAt(0)!=="/"?s+"/"+b:s+b:s;if(h&&d)Http.postRequestAsync(b,m,false,h);else if(h)Http.sendRequestAsync(b,false,h);else j=d?Http.postRequest(b,m,false):Http.sendRequest(b,false);return j}};AzureaUtil.ApiProxy=e;var u={};a(AzureaUtil.db,{get:g,set:c,del:f,keys:function(){var b,d=[];for(b in u)match.test(b)&&d.push(b);return d}});var p={PreProcessTimelineStatuses:[],
PreProcessTimelineStatus:[],PreFilterProcessTimelineStatus:[],PostFilterProcessTimelineStatus:[],PostProcessTimelineStatus:[],PostProcessTimelineStatuses:[],PreSendUpdateStatus:[],PostSendUpdateStatus:[],ReceiveFavorite:[]};a(AzureaUtil.event,{PreProcessTimelineStatuses:p.PreProcessTimelineStatuses,PreProcessTimelineStatus:p.PreProcessTimelineStatus,PreFilterProcessTimelineStatus:p.PreFilterProcessTimelineStatus,PostFilterProcessTimelineStatus:p.PostFilterProcessTimelineStatus,PostProcessTimelineStatus:p.PostProcessTimelineStatus,
PostProcessTimelineStatuses:p.PostProcessTimelineStatuses,PreSendUpdateStatus:p.PreSendUpdateStatus,PostSendUpdateStatus:p.PostSendUpdateStatus,ReceiveFavorite:p.ReceiveFavorite,addEventListener:k,removeEventListener:function(b,d){for(var h=p[b],j=-1;h[++j];)if(h[j]===d){h.splice(j,1);break}}});var q={},v={};timeevent_list=function(){for(var b={},d,h=-1;d=g("TimeEvent"+ ++h);)b[d.substring(0,d.indexOf(":"))]=[d.substring(d.indexOf(":")+1,d.indexOf("|"))-0,eval("(function(){return "+d.substring(d.indexOf("|")+
1)+"})()"),h];return b}();k("PreProcessTimelineStatus",n);k("PostSendUpdateStatus",n);k("ReceiveFavorite",n);a(AzureaUtil.time,{setTimeout:function(b,d){var h=Math.floor(Math.random()*(new Date).getTime()).toString(36);q[h]=[(new Date).getTime()+d,b];return h},clearTimeout:function(b){delete q[b]},setInterval:function(b,d){var h=Math.floor(Math.random()*(new Date).getTime()).toString(36);timeinterval_list[h]=[(new Date).getTime()+d,b,d];return h},clearInterval:function(b){delete timeinterval_list[b]},
setTimeevent:function(b,d){for(var h=Math.floor(Math.random()*(new Date).getTime()).toString(36),j=-1;g("TimeEvent"+ ++j););c("TimeEvent"+j,h+":"+d+"|"+b);timeevent_list[h]=[d,eval("(function(){return "+b+"})()"),j];return h},clearTimeevent:function(b){f("TimeEvent"+timeevent_list[b][2]);delete timeevent_list[b]}});a(AzureaUtil.template,{expand:function(b,d){function h(i){var l,t,w;if(typeof i==="string"||i instanceof String)l='"'+i.replace('"','\\"')+'"';else if(typeof i==="number"||i instanceof
Number)l=i.toString(10);else if(i===true||i===false)l=i;else if(i===null)l="null";else if(typeof i==="undefined")l="void(0)";else if(i instanceof Array){l="[";t=0;for(w=i.length;t<w;++t)l+=h(i[t])+",";l=l.replace(/,$/,"")+"]"}else{l="{";for(t in i)if(i.hasOwnProperty(t))l+='"'+t+'":'+h(i[t])+",";l=l.replace(/,$/,"")+"}"}return l}var j,s=function(){var i,l="";for(i in d)if(d.hasOwnProperty(i))l+="var "+i+"="+h(d[i])+";";return l}(),m=b.replace(/#{([^}]+?)}/g,function(i,l){return eval("(function(){"+
s+"return ("+l+")})()")});m=m.split("#{}");if(m.length===1){j=0;m=m[0]}else{j=m[0].length;m=m.join("")}return{text:m,cursor:j}}});a(AzureaUtil.yank,{get:function(b){if(b){b=b.charAt(0);if(/[0-9A-Za-z]/.test(b))b=""}else b="";return g("Yank"+b)},set:function(b,d){if(b){b=b.charAt(0);if(/[0-9A-Za-z]/.test(b))b=""}else b="";c("Yank"+b,d);return d}});new e("gntp");AzureaUtil.notify=function(b){try{o(b)}catch(d){o(b)}}})();
function PreProcessTimelineStatus(a){for(var e=AzureaUtil.event.PreProcessTimelineStatus,c=-1;e[++c];)e[c](a)}function PreFilterProcessTimelineStatus(a){for(var e=AzureaUtil.event.PreFilterProcessTimelineStatus,c=-1,g,f=false;e[++c];){g=e[c](a);f=f||g}return f}function PreSendUpdateStatus(a){for(var e=AzureaUtil.event.PreSendUpdateStatus,c=-1,g,f=false;e[++c];){g=e[c](a);f=f||g}return f}function PostSendUpdateStatus(){for(var a=AzureaUtil.event.PostSendUpdateStatus,e=-1;a[++e];)a[e]()}
function ReceiveFavorite(a,e,c){for(var g=AzureaUtil.event.ReceiveFavorite,f=-1;g[++f];)g[f](a,e,c)}AzureaVim={};
(function(){function a(c){var g=TwitterService.status,f=c.in_reply_to_status_id,k=g.get(f);c=this.command_text=c.text.slice(1);var n=[],o,r=/[^\s"]+|\s+|"[^\\"]*(?:\\.[^\\"]*)*"/g;for(c=c.replace(/^\s+|\s+$/g,"");o=r.exec(c);)/^\s/.test(o[0])||n.push(o[0].replace(/^"|"$/g,""));this.command=n;this.status_id=f;this.screen_name=k.user.screen_name;this.status_text=k.text;this.status_urls=[];this.status_hashes=[];this.status_users=[];g.getUrls(f,this.status_urls);g.getHashes(f,this.status_hashes);g.getUsers(f,
this.status_users)}var e={};System.addKeyBindingHandler(186,0,function(c){AzureaUtil.yank.set(null,TextArea.text);TextArea.text=":";TextArea.in_reply_to_status_id=c;TextArea.show();TextArea.setFocus();TextArea.setCursor(1)});System.addContextMenuHandler(":vim",0,function(){var c=System.inputBox("command","",true);AzureaUtil.yank.set(null,c);(new a({text:":"+c,in_reply_to_status_id:System.views.selectedStatusId})).run()});AzureaUtil.event.addEventListener("PreSendUpdateStatus",function(c){var g,f=
false;try{if(c.text===":"){f=true;AzureaUtil.time.setTimeout(function(){TextArea.text=AzureaUtil.yank.get(null);TextArea.show()},0)}else if(/^(?::|\uff1a)/.test(c.text)){f=true;AzureaUtil.yank.set(null,c.text);g=new a(c);TextArea.text="";TextArea.in_reply_to_status_id=0;g.run()}else AzureaUtil.yank.set(null,c.text)}catch(k){System.alert(k.name+":\n"+k.message);f=true}return f});AzureaVim=a;AzureaVim.commands_list=e;AzureaVim.prototype={run:function(){var c=this.command,g=e[this.command[0]];if(g){if(g.indexOf(" ")!==
-1){c.shift();c=this.command=g.split(" ").concat(c);g=c[0]}this[g]()}else System.showNotice(":"+c[0]+" command is undefined.")}}})();AzureaUtil.mixin(AzureaVim.commands_list,{unshorten:"unshorten","\u3046\u3093\u3057\u3087\uff52\u3066\uff4e":"unshorten"});
(function(){function a(f){for(var k=AzureaVim.prototype.unshorten.services,n=-1,o=false;k[++n];)if(f.indexOf(k[n])!==-1){o=true;break}return o}function e(f,k){var n=c,o,r=f;if(a(f))if(n[f])r=n[f];else if(k)try{Http.sendRequestAsync("http://untiny.me/api/1.0/extract/?url="+f+"&format=text",false,function(q){AzureaVim.prototype.unshorten.cashe[f]=/^error/.test(q.body)?f:q.body})}catch(u){}else try{o=Http.sendRequest("http://untiny.me/api/1.0/extract/?url="+f+"&format=text",false);r=/^error/.test(o.body)?
f:o.body;n[f]=r}catch(p){}return r}var c={"http://c4se.tk/":"http://c4se.sakura.ne.jp/"};AzureaUtil.event.addEventListener("PreProcessTimelineStatus",function(f){f.text=f.text.replace(/https?:\/\/[0-9A-Za-z._\-^~\/&%?]+/g,function(k){return e(k,true)})});AzureaVim.prototype.unshorten=function(){var f=this.status_urls[this.command[1]||0],k=e(f);System.inputBox(f,k,false);return k};AzureaVim.prototype.unshorten.services=[];AzureaVim.prototype.unshorten.cashe=c;AzureaVim.prototype.unshorten.unshorten=
e;try{Http.sendRequestAsync("http://untiny.me/api/1.0/services/?format=text",true,function(f){AzureaVim.prototype.unshorten.services=f.body.split(", ")})}catch(g){}})();AzureaUtil.mixin(AzureaVim.commands_list,{open:"open",o:"open","\u304a":"open",url:"open url","\u3046\uff52\uff4c":"open url"});
AzureaVim.prototype.open=function(){var a;a=this.unshorten?this.unshorten.unshorten:function(e){return e};switch({status:"status",favstar:"favstar",fav:"favstar",f:"favstar",favotter:"favotter",favlook:"favlook",twistar:"twistar",favolog:"favolog",twilog:"twilog",user:"user",url:"url"}[this.command[1]]){case "status":a="https://twitter.com/"+this.screen_name+"/status/"+this.status_id;break;case "favstar":a="http://favstar.fm/t/"+this.status_id;break;case "favotter":a="http://favotter.net/status.php?id="+
this.status_id;break;case "favlook":a="http://favlook.osa-p.net/status.html?status_id="+this.status_id;break;case "twistar":a="http://twistar.cc/"+this.screen_name+"/status/"+this.status_id;break;case "favolog":a="http://favolog.org/"+(this.command[2]||this.screen_name);break;case "twilog":a="http://twilog.org/"+(this.command[2]||this.screen_name);break;case "user":a="http://twitter.com/"+(this.command[2]||this.screen_name);break;case "url":this.command[2]||(this.command[2]=0);a=a(this.status_urls[this.command[2]],
true);break;default:a=this.status_urls[0]?a(this.status_urls[0],true):"https://twitter.com/"+this.screen_name+"/status/"+this.status_id}System.openUrl(a)};AzureaUtil.mixin(AzureaVim.commands_list,{reply:"reply",r:"reply","\uff52":"reply","@":"reply","\uff20":"reply",quotetweet:"reply quote",qt:"reply quote","\uff51\uff54":"reply quote",mrt:"reply mrt","\uff4d\uff52\uff54":"reply mrt"});
(function(){AzureaVim.prototype.reply=function(){var a;switch({template:"template",all:"all",quote:"quote",qt:"quote",mrt:"mrt",masirosiki:"mrt"}[this.command[1]]){case "template":a=AzureaUtil.template.expand(this.command[2],this);Http.sendRequestAsync("http://google.com/",false,new Function("TextArea.text = '"+a.text.replace("'","\\'")+"';TextArea.in_reply_to_status_id = '"+(this.command[3]==="true"?this.status_id:0)+"';TextArea.show();TextArea.setFocus();TextArea.setCursor("+a.cursor+");"));break;
case "all":this.command=["reply","template","@#{screen_name + (status_users.length ? ' @' +status_users.join(' @') : '')} #{}","true"];this.reply();break;case "quote":this.command=["reply","template","@#{screen_name} #{} RT: #{status_text}","true"];this.reply();break;case "mrt":this.command=this.command[2]==="f"||this.command[2]==="fav"||this.command[2]==="favstar"?["reply","template","#{} MRT: #{'http://favstar.fm/t/' + status_id}","false"]:["reply","template","#{} MRT: #{'http://twitter.com/' + screen_name + '/status/' + status_id}",
"false"];this.reply();break;default:this.command=["reply","template","@#{screen_name} #{}#{status_hashes.length ? ' ' + status_hashes.join(' ') : ''}","true"];this.reply()}};System.addKeyBindingHandler(82,0,function(a){var e=TwitterService.status.get(a).user.screen_name,c=[];TwitterService.status.getHashes(a,c);TextArea.text="@"+e+" "+(c.length?" "+c.join(" "):"");TextArea.in_reply_to_status_id=a;TextArea.show();TextArea.setFocus();TextArea.setCursor(e.length+2)})})();
AzureaUtil.mixin(AzureaVim.commands_list,{retweet:"retweet",rt:"retweet","\uff52\uff54":"retweet"});AzureaVim.prototype.retweet=function(){TwitterService.retweet.create(this.status_id)};AzureaUtil.mixin(AzureaVim.commands_list,{settings:"settings",setting:"settings",set:"settings","\u305b\uff54":"settings",get:"settings","\u3052\uff54":"settings"});
AzureaVim.prototype.settings=function(){var a;a=this.command.slice(1).join("");a=a.split("::");a=[a[0]].concat(a[1].split("="));if(/^(?:get|\u3052\uff54)/.test(this.command[0]))a.length=2;if(a[2]){System.settings.setValue(a[0],a[1],a[2]);System.showNotice("Setting done: "+a[0]+"::"+a[1]+"="+a[2])}else System.showNotice("Getting done: "+a[0]+"::"+a[1]+"="+System.settings.getValue(a[0],a[1]))};AzureaUtil.mixin(AzureaVim.commands_list,{shindan:"shindanmaker","\u3057\u3093\u3060\uff4e":"shindanmaker"});
AzureaVim.prototype.shindanmaker=function(){for(var a,e=-1,c=this.unshorten?this.unshorten.unshorten:function(g){return g};a=c(this.status_urls[++e],true);)if(a.match("^http://shindanmaker.com/[0-9]+"))break;if(a)Http.postRequestAsync(a,"u="+encodeURI(this.command[1]||TwitterService.currentUser().screen_name),false,function(g){g.body.match("<textarea.*?>(.*?)</textarea>");TextArea.text=RegExp.$1;TextArea.in_reply_to_status_id=0;TextArea.show();TextArea.setFocus()})};
AzureaUtil.mixin(AzureaVim.commands_list,{translate:"translate",ja:"translate ja","\u3058\u3083":"translate ja"});
AzureaVim.prototype.translate=function(){this.command[1]||(this.command[1]="ja");Http.sendRequestAsync("https://www.googleapis.com/language/translate/v2?key=AIzaSyCva1yUIFIBRqXOZDJ0nrbGbm0bz3FIksc&q="+encodeURI(this.status_text)+"&target="+this.command[1],false,function(a){if(a.statusCode!==200)throw Error("Google Translate API Error. statusCode is "+a.statusCode+".");System.showMessage(a.body.match(/"translatedText"\s*:\s*"(.*)"/)[1],a.body.match(/"detectedSourceLanguage"\s*:\s*"(.*)"/)[1]+"-> ",
0)})};AzureaUtil.mixin(AzureaVim.commands_list,{view:"view",v:"view",home:"view home","\u307b\u3081":"view home",user:"view user","\u3046\u305b\uff52":"view user"});
AzureaVim.prototype.view=function(){var a=System.apiLevel>=11?System.views:System;switch({home:"home",timeline:"home",h:"home",mention:"mention",reply:"mention",r:"mention",m:"mention","@":"mention",message:"message",dm:"message",d:"message",user:"user",u:"user",search:"search",favorite:"favorite",fav:"favorite",f:"favorite",match:"match",following:"following",follow:"following",followers:"followers",follower:"followers",followed:"followers"}[this.command[1]]){case "home":a.openTimeline();break;case "mention":a.openMention();
break;case "message":a.openMessage();break;case "user":a.openUserTimeline(this.command[2]||this.screen_name,false);break;case "search":a.openSearch(this.command[2],false);break;case "favorite":a.openFavorite();break;case "match":a.openMatch(this.command[2],false);break;case "following":a.openFollwoing();break;case "followers":a.openFollowers()}};AzureaUtil.mixin(AzureaVim.commands_list,{earthquake:"earthquake",jisin:"earthquake","\u3048\u3042\uff52\uff54\uff48\u304f\u3042\u3051":"earthquake","\u3058\u3057\uff4e":"earthquake"});
(function(){function a(c){var g=AzureaUtil.db.get("EarthquakeMessage");if(c!=null)g=AzureaUtil.template.expand(g,c).text;return g}function e(c){c=c||AzureaUtil.db.get("EarthquakeMessage");AzureaUtil.db.set("EarthquakeMessage",c);return c}AzureaUtil.db.get("EarthquakeMessage")||AzureaUtil.db.set("EarthquakeMessage","\u5730\u9707\u306a\u3046 #{Date()}");AzureaVim.prototype.earthquake=function(){var c;switch(this.command[1]){case "set":if(this.command[2])c=e(this.command[2]);else{c=System.inputBox("\u5730\u9707\u306a\u3046\u6295\u7a3f\u6587",
a(),false);e(c);c=c}c=c;break;default:TwitterService.status.update(a(this),0)}return c};System.addKeyBindingHandler(40,2,function(){TwitterService.status.update(":earthquake",0)})})();AzureaUtil.mixin(AzureaVim.commands_list,{delay:"delay","\u3067\u3041\uff59":"delay"});
(function(){function a(e,c,g){Http.postRequestAsync("http://twitdelay.appspot.com/api/post","user_id="+TwitterService.currentUser.id+"&api_key="+AzureaUtil.db.get("DelayTwitDelayApiKey")+"&status="+e+"&at="+c,false,g)}AzureaUtil.db.get("DelayUseTwitDelay")&&AzureaUtil.db.set("DelayUseTwitDelay","0");AzureaVim.prototype.delay=function(){var e,c;if(e=this.command[1].match(/^(?:(?:(\d{4})-)?(\d{1,2})-(\d{1,2}) )?(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?$/)){c=new Date;e[1]&&c.setFullYear(e[1]);e[2]&&c.setMonth(e[2]-
1);e[3]&&c.setDate(e[3]);c.setHours(e[4]);c.setMinutes(e[5]);c.setSeconds(0);e[6]&&c.setSeconds(e[6]);this.command[1]=c.getTime();e=2}else{this.command[1]=(new Date).getTime()+(this.command[1]-0);e=1}this.command[2]=this.command.slice(2).join(" ");if(AzureaUtil.db.get("DelayUseTwitDelay")){c=new Date(this.command[1]);a(this.command[2],c.getUTCDate()+" "+c.getUTCMonth()+" "+c.getUTCFullYear()+" "+c.getUTCHours()+":"+c.getUTCMinutes()+":"+c.getUTCSeconds()+" +0000",function(){})}else e===1?AzureaUtil.time.setTimeout(function(g){return function(){TwitterService.status.update(g.command[2],
g.status_id)}}(this),this.command[1]-(new Date).getTime()):AzureaUtil.time.setTimeevent('function() {TwitterService.status.update("'+this.command[2]+'", "'+this.status_id+'");}',this.command[1])}})();AzureaUtil.mixin(AzureaVim.codelist,{});System.addKeyBindingHandler(67,2,function(a){a=TwitterService.status.get(a).text;System.clipboard=a;AzureaUtil.yank.set(null,a)});AzureaUtil.mixin(AzureaVim.commands_list,{eval:"_evaluate"});
AzureaVim.prototype._evaluate=function(){this.command[1]=this.command.slice(1).join(" ");System.inputBox(this.command[1],eval(this.command[1]),false)};
